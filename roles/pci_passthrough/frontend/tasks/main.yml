---
- ansible.builtin.include_role:
    name: opennebula/leader
  when: leader is undefined
  run_once: true

- name: Enable monitoring of all PCI devices
  opennebula.deploy.cfgtool:
    dest: /var/lib/one/remotes/etc/im/kvm-probes.d/pci.conf
    parser: Yaml
    actions:
      - put:
          path: [":filter"]
          value: "*:*"
  notify:
    - Sync Remotes

- name: "Get OpenNebula hosts information"
  ansible.builtin.shell:
    cmd: onehost list --json
    executable: /bin/bash
  changed_when: false
  register: one_hosts_shell
  delegate_to: "{{ leader }}"
  run_once: true

- name: "Set OpenNebula hosts list fact"
  ansible.builtin.set_fact:
    one_hosts_list: "{{ [((one_hosts_shell.stdout | from_json).HOST_POOL.HOST | default({}))] | flatten }}"
  when: one_hosts_shell.stdout is defined and one_hosts_shell.stdout != ""
  run_once: true

- name: "Apply PCI devices filtering per-node"
  ansible.builtin.include_tasks: process_node.yml
  loop: "{{ groups['node'] }}"
  loop_control:
    loop_var: node_name
  when:
    - hostvars[node_name] is defined
    - hostvars[node_name]['pci_passthrough_devices'] is defined
    - one_hosts_list is defined
  vars:
    one_node_name: "{{ hostvars[node_name]['ansible_host'] | default(node_name) }}"
    one_host: "{{ (one_hosts_list | selectattr('NAME', 'equalto', one_node_name) | list | first | default({})) }}"
  run_once: true